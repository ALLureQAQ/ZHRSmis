<template>
	<!-- pages/index/card1/index.wxml -->
	<view class="page-container">
		<!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
		<view class="user-info-section">

			<view class="user-details">
				<text class="user-name">{{ username || 'è¯·ç™»å½•' }}</text>
				<text class="user-welcome">æ¬¢è¿ä½¿ç”¨æ™ºæ…§ç‡ƒçƒ§Mis</text>
			</view>
			<view class="time-info">
				<text class="current-date">{{ currentDate }}</text>
				<text class="current-time">{{ currentTime }}</text>
			</view>
		</view>

		<!-- åŠŸèƒ½èœå•åŒºåŸŸ -->
		<view class="function-section">
			<view class="section-title">
				<text class="title-text">åŠŸèƒ½èœå•</text>
				<text class="title-sub">å¿«é€Ÿè®¿é—®ç³»ç»ŸåŠŸèƒ½</text>
			</view>

			<view class="function-grid">
				<!-- äº‹æ•…æ¡ˆä¾‹ -->
				<!-- <view class="function-card card-1" @tap="onDocumentTap1">
					<view class="card-icon">
						<text class="icon">ğŸ“š</text>
					</view>
					<view class="card-content">
						<text class="card-title">äº‹æ•…æ¡ˆä¾‹</text>
						<text class="card-desc">å­¦ä¹ å†å²äº‹æ•…æ¡ˆä¾‹</text>
					</view>
					<view class="card-badge" v-if="caseCount > 0">
						<text class="badge-text">{{ caseCount }}</text>
					</view>
				</view> -->

				<!-- åˆ¶åº¦æ–‡æ¡£ -->
				<view class="function-card card-2" @tap="onDocumentTap2">
					<view class="card-icon">
						<text class="icon">ğŸ“ƒ</text>
					</view>
					<view class="card-content">
						<text class="card-title">åˆ¶åº¦æ–‡æ¡£</text>
						<text class="card-desc">æŸ¥çœ‹ç®¡ç†åˆ¶åº¦æ–‡æ¡£</text>
					</view>
				</view>

				<!-- å®šæœŸä»»åŠ¡ -->
				<view class="function-card card-3" @tap="onDocumentTap3">
					<view class="card-icon">
						<text class="icon">ğŸ“…</text>
					</view>
					<view class="card-content">
						<text class="card-title">ä»»åŠ¡è·Ÿè¸ª</text>
						<text class="card-desc">ç®¡ç†å·¥ä½œä»»åŠ¡</text>
					</view>
					<view class="task-indicator" v-if="pendingTasks > 0">
						<text class="indicator-dot"></text>
					</view>
				</view>

				<!-- ç¼ºé™·ä¸ŠæŠ¥ -->
				<view class="function-card card-4" @tap="onDocumentTap4">
					<view class="card-icon">
						<text class="icon">âš ï¸</text>
					</view>
					<view class="card-content">
						<text class="card-title">ç¼ºé™·ä¸ŠæŠ¥</text>
						<text class="card-desc">ä¸ŠæŠ¥è®¾å¤‡ç¼ºé™·é—®é¢˜</text>
					</view>
				</view>

				<!-- éšæ‚£æ•´æ”¹ -->
				<!-- <view class="function-card card-5" @tap="onDocumentTap5">
					<view class="card-icon">
						<text class="icon">ğŸ”</text>
					</view>
					<view class="card-content">
						<text class="card-title">éšæ‚£æ•´æ”¹</text>
						<text class="card-desc">è·Ÿè¸ªéšæ‚£æ•´æ”¹è¿›åº¦</text>
					</view>
				</view> -->

				<!-- é£é™©æ•´æ”¹ -->
				<!-- <view class="function-card card-6" @tap="onDocumentTap6">
					<view class="card-icon">
						<text class="icon">ğŸš¨</text>
					</view>
					<view class="card-content">
						<text class="card-title">é£é™©æ•´æ”¹</text>
						<text class="card-desc">ç®¡ç†é£é™©æ•´æ”¹äº‹é¡¹</text>
					</view>
				</view> -->

				<!-- å·¡ç‚¹æ£€ -->
				<view class="function-card card-7" @tap="onDocumentTap7">
					<view class="card-icon">
						<text class="icon">ğŸ“</text>
					</view>
					<view class="card-content">
						<text class="card-title">å·¡ç‚¹æ£€</text>
						<text class="card-desc">æ‰§è¡Œå·¡æ£€å·¥ä½œä»»åŠ¡</text>
					</view>
					<view class="feature-tag">
						<text class="tag-text">å¸¸ç”¨</text>
					</view>
				</view>
			</view>
		</view>

		<!-- ç‰ˆæœ¬ä¿¡æ¯å¼¹çª— -->
		

		<!-- åº•éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
		<!-- <view class="stats-section">
			<view class="stats-card">
				<view class="stats-item">
					<text class="stats-number">{{ pendingTasks }}</text>
					<text class="stats-label">å¾…åŠä»»åŠ¡</text>
				</view>
				<view class="stats-divider"></view>
				<view class="stats-item">
					<text class="stats-number">{{ completedTasks }}</text>
					<text class="stats-label">å·²å®Œæˆ</text>
				</view>
				<view class="stats-divider"></view>
				<view class="stats-item">
					<text class="stats-number">{{ thisWeekCount }}</text>
					<text class="stats-label">æœ¬å‘¨æ–°å¢</text>
				</view>
			</view>
		</view> -->
	</view>
</template>

<script>
	const systemInfo = uni.getSystemInfoSync();
	const current = systemInfo.appVersionCode; // è·å–appå½“å‰ç‰ˆæœ¬å·
	const token = uni.getStorageSync('token');






	export default {
		data() {
			return {
				username: '',
				currentDate: '',
				currentTime: '',
				// ç»Ÿè®¡æ•°æ®
				caseCount: 15,
				pendingTasks: 3,
				completedTasks: 42,
				thisWeekCount: 7,
				// å®šæ—¶å™¨
				timer: null,
				show:false,
				versionsFlag:0,
				// å½“å‰åº”ç”¨ç‰ˆæœ¬å·
				currentVersion : '',
				// æœåŠ¡å™¨è¿”å›çš„æ›´æ–°ä¿¡æ¯
				updateInfo :null
			}
		},
		onLoad: function() {
			this.checkUpdate();
			this.loadUserInfo();
			this.startClock();
		},
		onUnload() {
			// æ¸…é™¤å®šæ—¶å™¨
			if (this.timer) {
				clearInterval(this.timer);
			}
		},
		methods: {
			
			checkUpdate() {
				//ä»…åœ¨appç¯å¢ƒä¸‹è¿è¡Œ
				// #ifdef APP-PLUS 
				plus.runtime.getProperty(plus.runtime.appid, (widgetInfo) => {
					
					this.currentVersion = widgetInfo.version;
					var that = this
					uni.request({
						url: 'https://fdjt.qdsteel.com:5018/prod-api/mes/version/check?currentVersion=' +this.currentVersion,
						method: 'GET',
						header: {
							'content-type': 'application/json',
							'Authorization': token
						},
						success: function(res) {
							
							if (res.data.msg) {
								that.updateInfo = res.data.data;
								
								setTimeout(() => {
									that.showUpdateDialog();
								}, 1000);
								
								
							}		
						}
					});
				});
				// #endif
			},
			showUpdateDialog() {
				
				var that=this
				uni.showModal({
					title: 'å‘ç°æ–°ç‰ˆæœ¬',
					content: that.updateInfo.description,
					confirmText: 'ç«‹å³æ›´æ–°',
					cancelText: 'ç¨åå†è¯´',
					showCancel: !that.updateInfo.forceUpdate, // å¼ºåˆ¶æ›´æ–°æ—¶ç¦æ­¢å–æ¶ˆ
					success: (res) => {
						if (res.confirm) {
							that.downloadApp();
						} else if (that.updateInfo.forceUpdate) {
							plus.runtime.quit();
						}
					}
				});
			},
			
			downloadApp() {
				console.log('ä¸‹è½½åœ°å€:', this.updateInfo.downloadUrl);
				let showLoading = plus.nativeUI.showWaiting('æ­£åœ¨ä¸‹è½½');
				const downloadTask = uni.downloadFile({
					url: this.updateInfo.downloadUrl,
					success: (res) => {
						console.log('ä¸‹è½½ç»“æœ:', res); // æ·»åŠ æ—¥å¿—
						if (res.statusCode === 200) {
							console.log('å¼€å§‹å®‰è£…:', res.tempFilePath); // æ·»åŠ æ—¥å¿—
							plus.runtime.install(
								res.tempFilePath, {
									force: false
								},
								() => {
									console.log('å®‰è£…æˆåŠŸ'); // æ·»åŠ æ—¥å¿—
									plus.nativeUI.closeWaiting();
									plus.runtime.restart();
								},
								(error) => {
									console.error('å®‰è£…å¤±è´¥:', error); // æ·»åŠ é”™è¯¯æ—¥å¿—
									plus.nativeUI.closeWaiting();
									uni.showToast({
										title: 'å®‰è£…å¤±è´¥: ' + error.message,
										icon: 'none',
										duration: 2000
									});
								}
							);
						} else {
							console.error('ä¸‹è½½çŠ¶æ€ç å¼‚å¸¸:', res.statusCode); // æ·»åŠ é”™è¯¯æ—¥å¿—
							plus.nativeUI.closeWaiting();
							uni.showToast({
								title: 'ä¸‹è½½å¤±è´¥: ' + res.statusCode,
								icon: 'none',
								duration: 2000
							});
						}
					},
					fail: (err) => {
						console.error('ä¸‹è½½å¤±è´¥:', err); // æ·»åŠ é”™è¯¯æ—¥å¿—
						plus.nativeUI.closeWaiting();
						uni.showToast({
							title: 'ä¸‹è½½å¤±è´¥: ' + err.errMsg,
							icon: 'none',
							duration: 2000
						});
					}
				});
			
				//ç›‘å¬ä¸‹è½½è¿›åº¦
				downloadTask.onProgressUpdate((res) => {
					console.log('ä¸‹è½½è¿›åº¦:', res.progress); // æ·»åŠ è¿›åº¦æ—¥å¿—
					if (res.progress > 0) { // åªåœ¨æœ‰å®é™…è¿›åº¦æ—¶æ›´æ–°æç¤º
						showLoading.setTitle('æ­£åœ¨ä¸‹è½½' + res.progress + '%');
					}
				});
			},
			
			
			loadUserInfo() {
				const username = uni.getStorageSync('username');
				if (username) {
					this.username = username;
				}
			},
			startClock() {
				// æ›´æ–°æ—¶é—´æ˜¾ç¤º
				const updateTime = () => {
					const now = new Date();

					// æ ¼å¼åŒ–æ—¥æœŸ
					const year = now.getFullYear();
					const month = String(now.getMonth() + 1).padStart(2, '0');
					const day = String(now.getDate()).padStart(2, '0');
					this.currentDate = `${year}-${month}-${day}`;

					// æ ¼å¼åŒ–æ—¶é—´
					const hours = String(now.getHours()).padStart(2, '0');
					const minutes = String(now.getMinutes()).padStart(2, '0');
					this.currentTime = `${hours}:${minutes}`;
				};
				// ç«‹å³æ›´æ–°ä¸€æ¬¡
				updateTime();
				// æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
				this.timer = setInterval(updateTime, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
			},
			onDocumentTap1: function(e) {
				this.navigateWithAnimation('/pages/index/shigu/index');
			},
			onDocumentTap2: function(e) {
				this.navigateWithAnimation('/pages/index/zhidu/index');
			},
			onDocumentTap3: function(e) {
				this.navigateWithAnimation('/pages/index/dqwork/index');
			},
			onDocumentTap4: function(e) {
				this.navigateWithAnimation('/pages/index/xunjian/quexian/index');
			},
			onDocumentTap5: function(e) {
				this.navigateWithAnimation('/pages/index/xunjian/jiancha');
			},
			onDocumentTap6: function(e) {
				this.navigateWithAnimation('/pages/index/risk/index');
			},
			onDocumentTap7: function(e) {
				// uni.navigateTo({
				// 	url: '/pages/index/xunjian/jiancha?deviceId='+60
				// });
				uni.scanCode({
					onlyFromCamera: true, // å…è®¸ä»ç›¸å†Œé€‰æ‹©
					scanType: ['qrCode'],
					success: (res) => {
						console.log(res.result)
						uni.navigateTo({
							url: '/pages/index/xunjian/jiancha?deviceId=' + res.result
						});

					},
					fail: (err) => {
						console.error('æ‰«æå¤±è´¥:', err);
						// å¿½ç•¥ç”¨æˆ·å–æ¶ˆæ“ä½œçš„é”™è¯¯æç¤º
					}
				});





			},
			navigateWithAnimation(url) {
				// æ·»åŠ ç‚¹å‡»åé¦ˆ
				uni.vibrateShort();

				// å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·æœ‰åé¦ˆæ„Ÿ
				setTimeout(() => {
					uni.navigateTo({
						url: url,
						animationType: 'slide-in-right',
						animationDuration: 300
					});
				}, 100);
			}
		}
	};
</script>

<style>
	.page-container {
		min-height: 100vh;
		background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
		padding: 30rpx;
		display: flex;
		flex-direction: column;
	}

	/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
	.user-info-section {
		background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
		border-radius: 24rpx;
		padding: 40rpx 30rpx;
		display: flex;
		align-items: center;
		box-shadow: 0 10rpx 30rpx rgba(52, 152, 219, 0.3);
		margin-bottom: 40rpx;
		position: relative;
		overflow: hidden;
	}

	.user-info-section::before {
		content: '';
		position: absolute;
		top: -50%;
		right: -50%;
		width: 200%;
		height: 200%;
		background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
		background-size: 30rpx 30rpx;
		opacity: 0.3;
	}

	.user-avatar {
		width: 100rpx;
		height: 100rpx;
		border-radius: 50%;
		background: white;
		display: flex;
		align-items: center;
		justify-content: center;
		margin-right: 24rpx;
		overflow: hidden;
		border: 4rpx solid rgba(255, 255, 255, 0.3);
	}

	.user-avatar image {
		width: 80%;
		height: 80%;
		border-radius: 50%;
	}

	.user-details {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	.user-name {
		font-size: 36rpx;
		font-weight: bold;
		color: white;
		margin-bottom: 8rpx;
	}

	.user-welcome {
		font-size: 26rpx;
		color: rgba(255, 255, 255, 0.9);
	}

	.time-info {
		display: flex;
		flex-direction: column;
		align-items: flex-end;
	}

	.current-date {
		font-size: 28rpx;
		color: white;
		font-weight: 500;
		margin-bottom: 6rpx;
	}

	.current-time {
		font-size: 32rpx;
		color: white;
		font-weight: bold;
	}

	/* åŠŸèƒ½åŒºåŸŸ */
	.function-section {
		flex: 1;
		margin-bottom: 40rpx;
	}

	.section-title {
		margin-bottom: 40rpx;
		padding: 0 10rpx;
	}

	.title-text {
		font-size: 40rpx;
		font-weight: bold;
		color: #2c3e50;
		display: block;
		margin-bottom: 10rpx;
	}

	.title-sub {
		font-size: 28rpx;
		color: #7f8c8d;
	}

	.function-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 24rpx;
	}

	.function-card {
		background: white;
		border-radius: 20rpx;
		padding: 30rpx;
		display: flex;
		align-items: center;
		position: relative;
		box-shadow: 0 6rpx 20rpx rgba(0, 0, 0, 0.08);
		transition: all 0.3s ease;
		border: 2rpx solid transparent;
	}

	.function-card:active {
		transform: translateY(4rpx);
		box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.1);
	}

	.function-card:hover {
		border-color: rgba(52, 152, 219, 0.2);
	}

	.card-icon {
		width: 80rpx;
		height: 80rpx;
		border-radius: 16rpx;
		display: flex;
		align-items: center;
		justify-content: center;
		margin-right: 24rpx;
		font-size: 40rpx;
	}

	.card-content {
		flex: 1;
	}

	.card-title {
		font-size: 32rpx;
		font-weight: 600;
		color: #2c3e50;
		display: block;
		margin-bottom: 8rpx;
	}

	.card-desc {
		font-size: 24rpx;
		color: #7f8c8d;
	}

	/* å¡ç‰‡é¢œè‰² */
	.card-1 .card-icon {
		background: linear-gradient(135deg, #FF9A9E 0%, #FAD0C4 100%);
	}

	.card-2 .card-icon {
		background: linear-gradient(135deg, #A1C4FD 0%, #C2E9FB 100%);
	}

	.card-3 .card-icon {
		background: linear-gradient(135deg, #FFECD2 0%, #FCB69F 100%);
	}

	.card-4 .card-icon {
		background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
	}

	.card-5 .card-icon {
		background: linear-gradient(135deg, #84FAB0 0%, #8FD3F4 100%);
	}

	.card-6 .card-icon {
		background: linear-gradient(135deg, #FFD1FF 0%, #FAD0C4 100%);
	}

	.card-7 .card-icon {
		background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
	}

	/* å¾½ç« å’Œæ ‡ç­¾ */
	.card-badge {
		position: absolute;
		top: 20rpx;
		right: 20rpx;
		background: #e74c3c;
		color: white;
		width: 36rpx;
		height: 36rpx;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 22rpx;
		font-weight: bold;
	}

	.task-indicator {
		position: absolute;
		top: 20rpx;
		right: 20rpx;
	}

	.indicator-dot {
		display: block;
		width: 16rpx;
		height: 16rpx;
		background: #27ae60;
		border-radius: 50%;
	}

	.feature-tag {
		position: absolute;
		bottom: 20rpx;
		right: 20rpx;
		background: #3498db;
		padding: 6rpx 16rpx;
		border-radius: 20rpx;
	}

	.tag-text {
		font-size: 22rpx;
		color: white;
		font-weight: 500;
	}

	/* ç»Ÿè®¡åŒºåŸŸ */
	.stats-section {
		margin-top: auto;
	}

	.stats-card {
		background: white;
		border-radius: 20rpx;
		padding: 30rpx;
		display: flex;
		justify-content: space-around;
		box-shadow: 0 6rpx 20rpx rgba(0, 0, 0, 0.08);
	}

	.stats-item {
		display: flex;
		flex-direction: column;
		align-items: center;
		flex: 1;
	}

	.stats-number {
		font-size: 48rpx;
		font-weight: bold;
		color: #3498db;
		margin-bottom: 8rpx;
	}

	.stats-label {
		font-size: 26rpx;
		color: #7f8c8d;
	}

	.stats-divider {
		width: 2rpx;
		height: 60rpx;
		background: #f0f0f0;
		margin: 0 20rpx;
	}

	/* å“åº”å¼è°ƒæ•´ */
	@media (max-width: 700rpx) {
		.function-grid {
			grid-template-columns: 1fr;
			gap: 20rpx;
		}

		.user-info-section {
			flex-direction: column;
			text-align: center;
			padding: 40rpx 20rpx;
		}

		.user-avatar {
			margin-right: 0;
			margin-bottom: 20rpx;
		}

		.user-details {
			margin-bottom: 20rpx;
			align-items: center;
		}

		.time-info {
			align-items: center;
		}

		.stats-card {
			padding: 20rpx;
		}

		.stats-number {
			font-size: 40rpx;
		}

		.stats-label {
			font-size: 24rpx;
		}
	}

	/* åŠ¨ç”»æ•ˆæœ */
	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(30rpx);
		}

		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.function-card {
		animation: fadeInUp 0.5s ease forwards;
		opacity: 0;
	}

	.function-card:nth-child(1) {
		animation-delay: 0.1s;
	}

	.function-card:nth-child(2) {
		animation-delay: 0.2s;
	}

	.function-card:nth-child(3) {
		animation-delay: 0.3s;
	}

	.function-card:nth-child(4) {
		animation-delay: 0.4s;
	}

	.function-card:nth-child(5) {
		animation-delay: 0.5s;
	}

	.function-card:nth-child(6) {
		animation-delay: 0.6s;
	}

	.function-card:nth-child(7) {
		animation-delay: 0.7s;
	}
</style>